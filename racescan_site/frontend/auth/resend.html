<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Log In - RaceScan</title>
    <link rel="stylesheet" href="../static/css/login.css">
    <script src="../static/js/load-navbar.js"></script>
    <link rel="icon" type="image/x-icon" href="/static/images/RaceScan.ico">
</head>
<body>
<!-- Navbar Container -->
<div id="navbar-container"></div>

<div class="login-container">
    <h1>Log In</h1>
    <form id="login-form">
        <input type="email" id="email" placeholder="Email Address" required>
        <input type="password" id="password" placeholder="Password" required>
        <button type="submit">Log In</button>
    </form>
    <p>Don't have an account? <a href="/auth/signup.html">Sign Up</a></p>
    <p><a href="/auth/reset-password.html">Forgot Password?</a></p>
</div>

<!-- ðŸ”¹ Error/Success Messages -->
<div id="message-container" style="display: none;">
    <p id="message"></p>
    <button id="resend-verification" style="display: none;">Resend Verification Email</button>
</div>

<script>
    document.getElementById('login-form').addEventListener('submit', async function (e) {
        e.preventDefault();

        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const messageEl = document.getElementById('message');
        const messageContainer = document.getElementById('message-container');
        const resendButton = document.getElementById('resend-verification');

        console.log('ðŸ“¤ Sending login request:', { email, password });

        try {
            const response = await fetch('/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password }),
                cache: 'no-cache'
            });

            console.log('ðŸ“¥ Server response:', response);
            const data = await response.json();
            console.log('ðŸ”¹ Response data:', data);

            messageEl.textContent = `âŒ ${data.message}`;
            messageContainer.style.display = 'block';

            if (response.ok) {
                messageEl.style.color = 'green';
                messageEl.textContent = `âœ… Success: ${data.message}`;
                setTimeout(() => {
                    window.location.replace(data.redirect);
                }, 1000);
            } else {
                messageEl.style.color = 'red';

                if (data.action === 'verify_email') {
                    resendButton.style.display = "block";
                    resendButton.setAttribute("data-email", data.email); // Store email in button
                } else {
                    resendButton.style.display = "none";
                }
            }
        } catch (error) {
            console.error('âŒ Fetch error:', error);
            messageEl.textContent = 'âŒ An error occurred. Please try again.';
            messageContainer.style.display = 'block';
            resendButton.style.display = "none";
        }
    });

    // âœ… Resend Verification Email Function
    document.getElementById('resend-verification').addEventListener('click', async function () {
        const email = this.getAttribute("data-email"); // Retrieve stored email
        if (!email) return;

        this.textContent = "â³ Sending...";
        this.disabled = true;

        try {
            const response = await fetch('/resend-code', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email }) // âœ… Send email in request body
            });

            const data = await response.json();

            if (response.ok) {
                this.textContent = "âœ… Verification Email Sent!";
                this.style.color = "green";
            } else {
                this.textContent = "âŒ Error Sending Email";
                this.style.color = "red";
            }

        } catch (error) {
            console.error("âŒ Error resending code:", error);
            this.textContent = "âŒ Failed to Send Email";
            this.style.color = "red";
        }

        setTimeout(() => {
            this.textContent = "Resend Verification Email";
            this.disabled = false;
        }, 5000); // Reset button after 5 seconds
    });

</script>

</body>
</html>
